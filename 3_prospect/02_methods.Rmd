# Methods

```{r setupmethods, echo = FALSE, message = FALSE, warning = FALSE, cache = FALSE}
knitr::read_chunk(here::here("manuscript", "setup.R"))
knitr::read_chunk(here::here("manuscript", "datamap.R"))
```
```{r setup, echo = FALSE, message = FALSE, warning = FALSE}
```

## Data

Data from this project were assembled from XX projects on leaf spectra and related foliar traits (Table \@ref(tab:datadescribe)).
Most of these datasets are obtained directly from the ECOSIS spectral library (<https://ecosis.org/>)
Collectively, these data are comprised of XX observations from XX species, and span a wide geographic and climatic range (Figure \@ref(fig:datamap)).

(ref:datamap) Data map

```{r datamap, fig.cap = "(ref:datamap)"}
```

## Trait estimation via PROSPECT-D inversion

The PROSPECT-D leaf radiative transfer model [@feret2017_prospectd] simulates leaf reflectance and transmittance for 400 to 2500 nm wavelengths at 1 nm increments as a function of seven foliar morphological and biochemical traits:
The effective number of leaf mesophyll layers (unitless),
total chlorophyll content per area ($\mu~g cm^{-2}$),
total carotenoid content per area ($\mu~g cm^{-2}$),
total anthocynanin content per area ($\mu~g cm^{-2}$),
total "brown pigment" content (arbitrary units),
leaf water content per area ($g m^{-2}$),
and leaf dry matter content per area ($g m^{-2}$).

To estimate traits from leaf spectra, we generally followed the Bayesian RTM inversion approach of @shiklomanov2016_rse, except that we replaced the Metropolis-Hastings algorithm with a more efficient Differential Evolution algorithm with "snooker" update as implemented in the `BayesianTools` R package [@bayesiantools].
Forward simulations and Bayesian inversion of PROSPECT are implemented in the R package `PEcAnRTM` [@shiklomanov2016_rse], which is open source and freely available at <https://github.com/pecanproject/pecan/modules/rtm>.
Where leaf spectra extended beyond the 400 to 2500 nm wavelength range of the PROSPECT model, we used only the observations from 400 to 2500 nm.
Where leaf spectra were sampled at a spectral resolution coarser than 1 nm or did not include all wavelengths simulated by PROSPECT, we subset the PROSPECT output in the likelihood function to match the observations.
Where leaf spectra were sampled at a finer spectral resolution than 1 nm, or where wavelengths did not align at 1 nm intervals, we used cubic spline interpolation (default method in the R function `spline`) to align the spectra with PROSPECT output.
Where leaf spectra were provided as "pseudo-absorbance" ($1 - \log_{10}(R)$) or continuum-removed reflectance, we added the corresponding transformation to the PROSPECT output in the likelihood calculation [for continuum-removed reflectance, we used the `continuumRemoval` function from the R package `prospectr`, @prospectr].

## Analysis

To validate PROSPECT inversions, we compared trait estimates from PROSPECT inversion (see "[Trait estimation via PROSPECT-D inversion]") with direct measurements of the corresponding traits, where these traits were available.
In addition, we fit least-squares linear regressions to investigate the ability of trait estimates from spectra to predict the measured traits, and report the slopes, intercepts, and $R^2$ values of these regressions.
To assess the extent to which inversion accuracy was specific to measurement approach and species identity, we also fit these regressions separately for each project and for each project-species pair.

To investigate the effects of experimental treatments and environmental conditions, we fit a generalized linear fixed effects model for each optical trait and each treatment.
We then summarized the direction of each GLM coefficient, and whether the coefficient was significant, in a figure (Figure \@ref(fig:treatments)]).

To investigate the drivers of ecological variability in optical traits, we fit a fixed effects linear model to all optical trait estimates, excluding non-control groups for traits measured under specific conditions (e.g., experimental treatments, disturbances).
As explanatory variables for interspecific variability, we selected the following species attributes typically used for plant functional type definitions in terrestrial biosphere models or for otherwise aggregating plants into ecologically meaningful groups:
leaf morphology (broad, needle),
leaf phenology (deciduous, evergreen),
growth form (woody, herbaceous),
mycorrhizal association (arbuscular, ectomycorrhizal),
shade tolerance (high, intermediate, low).
In addition, those species that were present at multiple sites, we fit separate linear models with a site fixed effect, and examined how this site effect was related to site mean annual and mean growing season temperature and precipitation [obtained from the WorldClim dataset, @worldclim].

To investigate correlations of optical traits with other traits, we fit a Bayesian hierarchical multivariate model [R package `mvtraits`, @shiklomanov_newphyt] that explicitly separates within- and among-species trait correlations to all trait observations.
We then performed an eigendecomposition of the resulting among-species correlation matrix, and plotted the resulting eigenvectors (where they were significant).
Also, we performed the same pairwise covariance plot as Figure 4 in @shiklomanov_newphyt.

We performed all analyses using R version 3.4.3 [@rstats].
The data and code for performing these analyses are open source and freely available at <https://github.com/ashiklom/rspecan>.
