\section{Methods}

\subsection{Data}

Data from this project were assembled from XXX projects on leaf spectra and related foliar traits (Table~\ref{tab:projectinfo}).
Most of these datasets are obtained directly from the ECOSIS spectral library (https://ecosis.org/).
Collectively, these data are comprised of XX observations from XX species, and span a wide geographic (Figure~\ref{fig:datamap}) and climatic range (Figure~\ref{fig:dataclimate}).

\begin{table}
    \caption{Project information}
    \centering
    \input{\string figures/project_table.tex}
    \label{tab:projectinfo}
\end{table}

\begin{figure}
    \includegraphics{\string figures/data_map.pdf}
    \caption{Map of data locations}
    \label{fig:datamap}
\end{figure}

\begin{figure}
    \includegraphics{\string figures/data_climate.pdf}
    \caption{Data locations in climate space}
    \label{fig:dataclimate}
\end{figure}

\subsection{Trait estimation via PROSPECT inversion}

The PROSPECT leaf radiative transfer model \cite{jacquemoud1990_prospect,jacquemoud_2009_prosail,feret2008_prospect,feret2017_prospectd} simulates leaf reflectance and transmittance for 400 to 2500 nm wavelengths at 1 nm increments as a function of leaf morphological and biochemical characteristics.
In this chapter, I compared the performance of four different versions of PROSPECT, each of which uses a different combination of leaf traits:
PROSPECT 4 uses
total chlorophyll content per area ($\mu g ~ cm^{-2}$),
leaf water content per area ($g ~ m^{-2}$),
and leaf dry matter content per area ($g ~ m^{-2}$) \cite{feret2008_prospect}.
PROSPECT 5 extends PROSPECT 4 with a parameter for
total carotenoid content per area ($\mu g ~ cm^{-2}$) \cite{feret2008_prospect}.
PROSPECT 5B adds an additional parameter for
total "senescent brown pigment" content (arbitrary units) \cite{jacquemoud_2009_prosail}.
Finally, PROSPECT D adds an additional parameter for
total anthocynanin content per area ($\mu g ~ cm^{-2}$) \cite{feret2017_prospectd}.

To estimate traits from leaf spectra, we generally followed the Bayesian RTM inversion approach of \cite{shiklomanov2016_rse}, except that we replaced the Metropolis-Hastings algorithm with a more efficient Differential Evolution algorithm with "snooker" update as implemented in the ``BayesianTools'' R package \cite{bayesiantools}.
Forward simulations and Bayesian inversion of PROSPECT are implemented in the R package ``PEcAnRTM'' \cite{shiklomanov2016_rse}, which is open source and freely available at https://github.com/pecanproject/pecan/modules/rtm.
Where leaf spectra extended beyond the 400 to 2500 nm wavelength range of the PROSPECT model, we used only the observations from 400 to 2500 nm.
Where leaf spectra were sampled at a spectral resolution coarser than 1 nm or did not include all wavelengths simulated by PROSPECT, we subset the PROSPECT output in the likelihood function to match the observations.
Where leaf spectra were sampled at a finer spectral resolution than 1 nm, or where wavelengths did not align at 1 nm intervals, we used cubic spline interpolation (default method in the R function `spline`) to align the spectra with PROSPECT output.
Where leaf spectra were provided as ``pseudo-absorbance'' ($1 - \log_{10}(R)$), we added the corresponding transformation to the PROSPECT output in the likelihood calculation. 

\subsection{Analysis}

To compare PROSPECT versions, we plotted traits estimated by more than one version of PROSPECT as pairwise scatter plots, fit a least-squares linear regression to each and compared the result to a 1-to-1 line, and calculated the pairwise correlation coefficient (Figure XXX).
To validate PROSPECT inversions, we compared trait estimates from PROSPECT inversion with direct measurements of the corresponding traits, where these traits were available.
To explore project-specific biases in the inversion, we fit least-squares linear regressions to investigate the ability of trait estimates from spectra to predict the measured traits, and we report the slopes, intercepts, and $R^2$ values of those regressions (Table XXX).
To identify species-specific errors, we also calculated the mean absolute error (MAE) between the measured trait and inversion estimate for each species-project combination (Figure XXX).

To investigate the effects of experimental treatments and environmental conditions, we fit a linear fixed effects model for each optical trait and each treatment, with an additional fixed effect for species if multiple species were present in that treatment.
We then summarized the direction of each GLM coefficient, and whether the coefficient was significant, in a figure (Figure XXX).

%TODO: fill in the rest of the analyses

We performed all analyses using R version 3.4.4 \cite{rstats}.
The data and code for performing these analyses are open source and freely available at https://github.com/ashiklom/rspecan.
